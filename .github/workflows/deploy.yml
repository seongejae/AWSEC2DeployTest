name: CI/CD to EC2

on:
  push:
    branches:
      - main  # main 브랜치 푸시 시 자동 실행

jobs:
  # [1단계] 빌드 및 테스트 검증
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3  # 소스 코드 체크아웃

      - name: Set up JDK 17
        uses: actions/setup-java@v3  # JDK 17 및 라이브러리 환경 세팅
        with:
          java-version: '17'
          distribution: 'liberica'
          
      - name: Grant execute permission for Gradle Wrapper
        run: chmod +x ./gradlew  # Gradle 실행 권한 부여
        
      - name: Build with Gradle
        run: ./gradlew build  # 전체 프로젝트 빌드

      - name: Run Tests
        run: ./gradlew test  # 단위 테스트 실행 및 검증

  # [2단계] EC2 서버 배포
  deploy:
    name: Build and Deploy Spring Boot App to EC2
    needs: test  # 테스트 성공 시에만 배포 진행
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'liberica'
          java-version: '17'

      - name: Grant execute permission for Gradle Wrapper
        run: chmod +x ./gradlew

      - name: Build Spring Boot App
        # 이전 빌드 제거 및 테스트 제외 빌드 수행
        run: ./gradlew clean build -x test

      - name: Check built JARs
        run: ls -lh build/libs/  # 생성된 JAR 파일 목록 확인

      - name: Save EC2 SSH key
        # EC2 접속을 위한 SSH 키 생성 및 권한 설정
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 400 key.pem

      - name: Ensure remote app directory exists
        # 원격 서버 내 배포 디렉토리 생성 확인
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${{ secrets.EC2_APP_DIR }}"

      - name: Deploy JAR to EC2
        # 빌드된 JAR 파일을 EC2 원격 서버로 전송
        run: |
          scp -o StrictHostKeyChecking=no -i key.pem \
            build/libs/${{ secrets.APP_NAME }} \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_APP_DIR }}/${{ secrets.APP_NAME }}